{"version":3,"file":"diffReviewableModel.js","names":["RB","DiffReviewable","AbstractReviewable","extend","defaults","_","baseFileDiffID","file","fileDiffID","interdiffRevision","interFileDiffID","revision","prototype","commentBlockModel","DiffCommentBlock","defaultCommentBlockFields","loadSerializedCommentBlock","serializedCommentBlock","createCommentBlock","reviewRequest","get","review","beginLineNum","linenum","endLineNum","num_lines","serializedComments","comments","getRenderedDiff","options","arguments","length","undefined","context","oldOptions","isFunction","success","error","complete","console","warn","promiseToCallbacks","newOptions","_fetchFragment","url","_buildRenderedDiffURL","index","showDeleted","noActivityIndicator","getRenderedDiffFragment","assert","chunkIndex","linesOfContext","Promise","resolve","apiCall","type","dataType","xhr","responseText","reviewURL","revisionPart","fileDiffPart","queryParts","push","TEMPLATE_SERIAL","queryStr","join"],"sources":["../../../../../../static/rb/js/diffviewer/models/diffReviewableModel.es6.js"],"sourcesContent":["/**\n * Provides state and utility functions for loading and reviewing diffs.\n *\n * Model Attributes:\n *     baseFileDiffID (number):\n *         The ID of the base FileDiff.\n *\n *     fileDiffID (number):\n *         The ID of the FileDiff.\n *\n *     file (RB.DiffFile):\n *         Information on the file associated with this diff.\n *\n *     interdiffRevision (number):\n *         The revision on the end of an interdiff range.\n *\n *     interFileDiffID (number):\n *         The ID of the FileDiff on the end of an interdiff range.\n *\n *     revision (number):\n *         The revision of the FileDiff.\n *\n * See Also:\n *     :js:class:`RB.AbstractReviewable`:\n *         For the attributes defined by the base model.\n */\nRB.DiffReviewable = RB.AbstractReviewable.extend({\n    defaults: _.defaults({\n        baseFileDiffID: null,\n        file: null,\n        fileDiffID: null,\n        interdiffRevision: null,\n        interFileDiffID: null,\n        revision: null,\n    }, RB.AbstractReviewable.prototype.defaults),\n\n    commentBlockModel: RB.DiffCommentBlock,\n\n    defaultCommentBlockFields: [\n        'baseFileDiffID',\n        'fileDiffID',\n        'interFileDiffID',\n    ],\n\n    /**\n     * Load a serialized comment and add comment blocks for it.\n     *\n     * Args:\n     *     serializedCommentBlock (object):\n     *         The serialized data for the new comment block(s).\n     */\n    loadSerializedCommentBlock(serializedCommentBlock) {\n        this.createCommentBlock({\n            reviewRequest: this.get('reviewRequest'),\n            review: this.get('review'),\n            fileDiffID: this.get('fileDiffID'),\n            interFileDiffID: this.get('interFileDiffID'),\n            beginLineNum: serializedCommentBlock.linenum,\n            endLineNum: serializedCommentBlock.linenum +\n                        serializedCommentBlock.num_lines - 1,\n            serializedComments: serializedCommentBlock.comments || [],\n        });\n    },\n\n    /**\n     * Return the rendered diff for a file.\n     *\n     * The rendered file will be fetched from the server and eventually\n     * returned through the promise.\n     *\n     * Version Changed:\n     *     5.0:\n     *     Deprecated callbacks and added a promise return value.\n     *\n     * Args:\n     *     options (object, optional):\n     *         The option arguments that control the behavior of this function.\n     *\n     *     context (object, optional):\n     *         Context to bind when calling callbacks.\n     *\n     *     oldOptions (object, optional):\n     *         Previous location of the options parameter.\n     *\n     * Option Args:\n     *     showDeleted (boolean):\n     *         Determines whether or not we want to requeue the corresponding\n     *         diff in order to show its deleted content.\n     *\n     * Returns:\n     *     Promise:\n     *     A promise which resolves when the operation is complete.\n     */\n    getRenderedDiff(options={}, context=undefined, oldOptions={}) {\n        if (_.isFunction(options.success) ||\n            _.isFunction(options.error) ||\n            _.isFunction(options.complete)) {\n            console.warn('RB.DiffReviewable.getRenderedDiff was called ' +\n                         'using callbacks. Callers should be updated to ' +\n                         'use promises instead.');\n            return RB.promiseToCallbacks(\n                _.defaults({}, options, oldOptions), context,\n                newOptions => this.getRenderedDiff(newOptions));\n        }\n\n        return this._fetchFragment({\n            url: this._buildRenderedDiffURL({\n                index: this.get('file').get('index'),\n                showDeleted: options.showDeleted,\n            }),\n            noActivityIndicator: true,\n        });\n    },\n\n    /**\n     * Return a rendered fragment of a diff.\n     *\n     * The fragment will be fetched from the server and eventually returned\n     * through the promise.\n     *\n     * Version Changed:\n     *     5.0:\n     *     Deprecated callbacks and added a promise return value.\n     *\n     * Args:\n     *     options (object):\n     *         The option arguments that control the behavior of this function.\n     *\n     *     context (object, optional):\n     *         Context to bind when calling callbacks.\n     *\n     *     oldOptions (object, optional):\n     *         Previous location of the options parameter.\n     *\n     * Option Args:\n     *     chunkIndex (string):\n     *         The chunk index to load.\n     *\n     * Returns:\n     *     Promise:\n     *     A promise which resolves when the operation is complete.\n     */\n    getRenderedDiffFragment(options, context=undefined, oldOptions={}) {\n        if (_.isFunction(options.success) ||\n            _.isFunction(options.error) ||\n            _.isFunction(options.complete)) {\n            console.warn('RB.DiffReviewable.getRenderedDiffFragment was ' +\n                         'called using callbacks. Callers should be updated ' +\n                         'to use promises instead.');\n            return RB.promiseToCallbacks(\n                _.defaults({}, options, oldOptions), context,\n                newOptions => this.getRenderedDiffFragment(newOptions));\n        }\n\n        console.assert(options.chunkIndex !== undefined,\n                       'chunkIndex must be provided');\n\n        return this._fetchFragment({\n            url: this._buildRenderedDiffURL({\n                chunkIndex: options.chunkIndex,\n                index: this.get('file').get('index'),\n                linesOfContext: options.linesOfContext,\n            }),\n        });\n    },\n\n    /**\n     * Fetch the diff fragment from the server.\n     *\n     * This is used internally by getRenderedDiff and getRenderedDiffFragment\n     * to do all the actual fetching.\n     *\n     * Args:\n     *     options (object):\n     *         The option arguments that control the behavior of this function.\n     *\n     * Returns:\n     *     Promise:\n     *     A promise which resolves when the operation is complete.\n     */\n    _fetchFragment(options) {\n        return new Promise(resolve => {\n            RB.apiCall(_.defaults(\n                {\n                    type: 'GET',\n                    dataType: 'html',\n                    complete: xhr => resolve(xhr.responseText),\n                },\n                options));\n        });\n    },\n\n    /**\n     * Return a URL that forms the base of a diff fragment fetch.\n     *\n     * Args:\n     *     options (object):\n     *         Options for the URL.\n     *\n     * Option Args:\n     *     chunkIndex (number, optional):\n     *         The chunk index to load.\n     *\n     *     index (number, optional):\n     *         The file index to load.\n     *\n     *     linesOfContext (number, optional):\n     *         The number of lines of context to load.\n     *\n     *     showDeleted (boolean, optional):\n     *         Whether to show deleted content.\n     *\n     * Returns:\n     *     string:\n     *     The URL for fetching diff fragments.\n     */\n    _buildRenderedDiffURL(options={}) {\n        const reviewURL = this.get('reviewRequest').get('reviewURL');\n        const interdiffRevision = this.get('interdiffRevision');\n        const fileDiffID = this.get('fileDiffID');\n        const interFileDiffID = this.get('interFileDiffID');\n        const baseFileDiffID = this.get('baseFileDiffID');\n        const revision = this.get('revision');\n\n        const revisionPart = (interdiffRevision\n                              ? `${revision}-${interdiffRevision}`\n                              : revision);\n\n        const fileDiffPart = (interFileDiffID\n                              ? `${fileDiffID}-${interFileDiffID}`\n                              : fileDiffID);\n\n        let url = `${reviewURL}diff/${revisionPart}/fragment/${fileDiffPart}/`;\n\n        if (options.chunkIndex !== undefined) {\n            url += `chunk/${options.chunkIndex}/`;\n        }\n\n        /* Build the query string. */\n        const queryParts = [];\n\n        if (baseFileDiffID) {\n            queryParts.push(`base-filediff-id=${baseFileDiffID}`);\n        }\n\n        if (options.index !== undefined) {\n            queryParts.push(`index=${options.index}`);\n        }\n\n        if (options.linesOfContext !== undefined) {\n            queryParts.push(`lines-of-context=${options.linesOfContext}`);\n        }\n\n        if (options.showDeleted) {\n            queryParts.push(`show-deleted=1`);\n        }\n\n        queryParts.push(`_=${TEMPLATE_SERIAL}`);\n\n        const queryStr = queryParts.join('&');\n\n        return `${url}?${queryStr}`;\n    },\n});\n"],"mappings":"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"}
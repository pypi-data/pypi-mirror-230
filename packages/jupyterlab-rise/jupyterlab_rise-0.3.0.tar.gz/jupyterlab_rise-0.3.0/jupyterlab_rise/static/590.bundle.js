"use strict";(self.webpackChunk_JUPYTERLAB_CORE_OUTPUT=self.webpackChunk_JUPYTERLAB_CORE_OUTPUT||[]).push([[590],{40590:(e,s,t)=>{t.r(s),t.d(s,{IDocumentProviderFactory:()=>a,ProviderMock:()=>n,WebSocketProvider:()=>q,getAnonymousUserName:()=>i,getRandomColor:()=>h,moonsOfJupyter:()=>c,userColors:()=>r});class n{constructor(){this._isDisposed=!1}get isDisposed(){return this._isDisposed}get ready(){return Promise.resolve()}dispose(){this.isDisposed||(this._isDisposed=!0)}}var o=t(79645);const a=new o.Token("@jupyterlab/docprovider:IDocumentProviderFactory"),c=["Metis","Adrastea","Amalthea","Thebe","Io","Europa","Ganymede","Callisto","Themisto","Leda","Ersa","Pandia","Himalia","Lysithea","Elara","Dia","Carpo","Valetudo","Euporie","Eupheme","Helike","Euanthe","Hermippe","Praxidike","Thyone","Thelxinoe","Ananke","Mneme","Orthosie","Harpalyke","Iocaste","Erinome","Aitne","Herse","Taygete","Eukelade","Carme","Isonoe","Autonoe","Philophrosyne","Cyllene","Pasithee","Pasiphae","Sponde","Eurydome","Kalyke","Hegemone","Kale","Kallichore","Chaldene","Arche","Eirene","Kore","Megaclite","Aoede","Callirrhoe","Sinope"],i=()=>"Anonymous "+c[Math.floor(Math.random()*c.length)],r=["#12A0D3","#17AB30","#CC8500","#A79011","#ee6352","#609DA9","#4BA749","#00A1B3"],h=()=>r[Math.floor(Math.random()*r.length)];var d=t(79013),l=t(56297),u=t(62390),w=t(28306),m=t(22592),y=t(79287),f=t(47941),p=t(83149);const _=new Map,b="undefined"==typeof BroadcastChannel?class{constructor(e){this.room=e,this.onmessage=null,p.z((s=>s.key===e&&null!==this.onmessage&&this.onmessage({data:f.Gh(s.newValue||"")})))}postMessage(e){p.X.setItem(this.room,f.s3(f.eh(e)))}}:BroadcastChannel,g=e=>m.Yu(_,e,(()=>{const s=y.Ue(),t=new b(e);return t.onmessage=e=>s.forEach((s=>s(e.data,"broadcastchannel"))),{bc:t,subs:s}})),v=(e,s,t=null)=>{const n=g(e);n.bc.postMessage(s),n.subs.forEach((e=>e(s,t)))};var C=t(2431),E=t(74833),k=t(66962);const U=(e,s)=>{E.uE(e,0);const t=w.encodeStateVector(s);E.mP(e,t)},P=(e,s,t)=>{E.uE(e,1),E.mP(e,w.encodeStateAsUpdate(s,t))},M=(e,s,t)=>{try{w.applyUpdate(s,k.HN(e),t)}catch(e){console.error("Caught error while handling a Yjs update",e)}},I=M;var A=t(90157),S=t(12330),D=t(11182),H=t(36498),T=t(27061);const R=[];R[0]=(e,s,t,n,o)=>{E.uE(e,0);const a=((e,s,t,n)=>{const o=k.yg(e);switch(o){case 0:((e,s,t)=>{P(s,t,k.HN(e))})(e,s,t);break;case 1:M(e,t,n);break;case 2:I(e,t,n);break;default:throw new Error("Unknown message type")}return o})(s,e,t.doc,t);n&&1===a&&!t.synced&&(t.synced=!0)},R[3]=(e,s,t,n,o)=>{E.uE(e,1),E.mP(e,A.xq(t.awareness,Array.from(t.awareness.getStates().keys())))},R[1]=(e,s,t,n,o)=>{A.oy(t.awareness,k.HN(s),t)},R[2]=(e,s,t,n,o)=>{((e,s,t)=>{0===k.yg(e)&&t(0,k.kf(e))})(s,t.doc,((e,s)=>B(t,s)))};const B=(e,s)=>console.warn(`Permission denied to access ${e.url}.\n${s}`),x=(e,s,t)=>{const n=k.l1(s),o=E.Mf(),a=k.yg(n),c=e.messageHandlers[a];return c?c(o,n,e,t,a):console.error("Unable to compute message"),o},L=e=>{if(e.shouldConnect&&null===e.ws){const s=new e._WS(e.url);s.binaryType="arraybuffer",e.ws=s,e.wsconnecting=!0,e.wsconnected=!1,e.synced=!1,s.onmessage=t=>{e.wsLastMessageReceived=C.ZG();const n=x(e,new Uint8Array(t.data),!0);E.kE(n)>1&&s.send(E._f(n))},s.onerror=s=>{e.emit("connection-error",[s,e])},s.onclose=s=>{e.emit("connection-close",[s,e]),e.ws=null,e.wsconnecting=!1,e.wsconnected?(e.wsconnected=!1,e.synced=!1,A.Ag(e.awareness,Array.from(e.awareness.getStates().keys()).filter((s=>s!==e.doc.clientID)),e),e.emit("status",[{status:"disconnected"}])):e.wsUnsuccessfulReconnects++,setTimeout(L,D.VV(100*D.sQ(2,e.wsUnsuccessfulReconnects),e.maxBackoffTime),e)},s.onopen=()=>{e.wsLastMessageReceived=C.ZG(),e.wsconnecting=!1,e.wsconnected=!0,e.wsUnsuccessfulReconnects=0,e.emit("status",[{status:"connected"}]);const t=E.Mf();if(E.uE(t,0),U(t,e.doc),s.send(E._f(t)),null!==e.awareness.getLocalState()){const t=E.Mf();E.uE(t,1),E.mP(t,A.xq(e.awareness,[e.doc.clientID])),s.send(E._f(t))}},e.emit("status",[{status:"connecting"}])}},O=(e,s)=>{e.wsconnected&&e.ws.send(s),e.bcconnected&&v(e.bcChannel,s,e)};class W extends S.y{constructor(e,s,t,{connect:n=!0,awareness:o=new A.GL(t),params:a={},WebSocketPolyfill:c=WebSocket,resyncInterval:i=-1,maxBackoffTime:r=2500,disableBc:h=!1}={}){for(super();"/"===e[e.length-1];)e=e.slice(0,e.length-1);const d=(e=>H.UI(e,((e,s)=>`${encodeURIComponent(s)}=${encodeURIComponent(e)}`)).join("&"))(a);this.maxBackoffTime=r,this.bcChannel=e+"/"+s,this.url=e+"/"+s+(0===d.length?"":"?"+d),this.roomname=s,this.doc=t,this._WS=c,this.awareness=o,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=h,this.wsUnsuccessfulReconnects=0,this.messageHandlers=R.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=n,this._resyncInterval=0,i>0&&(this._resyncInterval=setInterval((()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){const e=E.Mf();E.uE(e,0),U(e,t),this.ws.send(E._f(e))}}),i)),this._bcSubscriber=(e,s)=>{if(s!==this){const s=x(this,new Uint8Array(e),!1);E.kE(s)>1&&v(this.bcChannel,E._f(s),this)}},this._updateHandler=(e,s)=>{if(s!==this){const s=E.Mf();E.uE(s,0),((e,s)=>{E.uE(e,2),E.mP(e,s)})(s,e),O(this,E._f(s))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:e,updated:s,removed:t},n)=>{const a=e.concat(s).concat(t),c=E.Mf();E.uE(c,1),E.mP(c,A.xq(o,a)),O(this,E._f(c))},this._unloadHandler=()=>{A.Ag(this.awareness,[t.clientID],"window unload")},"undefined"!=typeof window?window.addEventListener("unload",this._unloadHandler):void 0!==T&&T.on("exit",this._unloadHandler),o.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval((()=>{this.wsconnected&&3e4<C.ZG()-this.wsLastMessageReceived&&this.ws.close()}),3e3),n&&this.connect()}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e,this.emit("synced",[e]),this.emit("sync",[e]))}destroy(){0!==this._resyncInterval&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),"undefined"!=typeof window?window.removeEventListener("unload",this._unloadHandler):void 0!==T&&T.off("exit",this._unloadHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;var e,s;this.bcconnected||(e=this.bcChannel,s=this._bcSubscriber,g(e).subs.add(s),this.bcconnected=!0);const t=E.Mf();E.uE(t,0),U(t,this.doc),v(this.bcChannel,E._f(t),this);const n=E.Mf();E.uE(n,0),P(n,this.doc),v(this.bcChannel,E._f(n),this);const o=E.Mf();E.uE(o,3),v(this.bcChannel,E._f(o),this);const a=E.Mf();E.uE(a,1),E.mP(a,A.xq(this.awareness,[this.doc.clientID])),v(this.bcChannel,E._f(a),this)}disconnectBc(){const e=E.Mf();E.uE(e,1),E.mP(e,A.xq(this.awareness,[this.doc.clientID],new Map)),O(this,E._f(e)),this.bcconnected&&(((e,s)=>{const t=g(e);t.subs.delete(s)&&0===t.subs.size&&(t.bc.close(),_.delete(e))})(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),null!==this.ws&&this.ws.close()}connect(){this.shouldConnect=!0,this.wsconnected||null!==this.ws||(L(this),this.connectBc())}}class q{constructor(e){this._ready=new o.PromiseDelegate,this._isDisposed=!1,this._path=e.path,this._contentType=e.contentType,this._format=e.format,this._serverUrl=e.url,this._ydoc=e.model.ydoc,this._awareness=e.model.awareness;const s=e.user;null==s||s.ready.then((()=>{this._onUserChanged(s)})).catch((e=>console.error(e))),null==s||s.userChanged.connect(this._onUserChanged,this);const t=l.ServerConnection.makeSettings(),n=d.URLExt.join(t.baseUrl,"api/yjs/roomid",encodeURIComponent(this._path)),a={method:"PUT",body:JSON.stringify({format:this._format,type:this._contentType})};l.ServerConnection.makeRequest(n,a,t).then((e=>{if(200!==e.status&&201!==e.status)throw new l.ServerConnection.ResponseError(e);return e.text()})).then((e=>{this._yWebsocketProvider=new W(this._serverUrl,e,this._ydoc,{awareness:this._awareness})})).then((()=>this._ready.resolve())).catch((e=>console.warn(e)))}get isDisposed(){return this._isDisposed}get ready(){return this._ready.promise}dispose(){this.isDisposed||(this._isDisposed=!0,this._yWebsocketProvider.destroy(),u.Signal.clearData(this))}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}}}}]);
//# sourceMappingURL=590.js.map